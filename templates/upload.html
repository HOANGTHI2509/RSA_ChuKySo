<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G·ª≠i file - File Transfer RSA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="dashboard">
        <nav class="navbar">
            <div class="nav-brand">
                <h2>üì§ G·ª≠i file</h2>
            </div>
            <div class="nav-user">
                {% if is_admin %}
                <a href="/admin" class="btn btn-secondary">‚öôÔ∏è Quay l·∫°i Admin</a>
                {% endif %}
                <a href="/dashboard" class="btn btn-secondary">üè† Quay l·∫°i Dashboard</a>
                <a href="/logout" class="btn btn-secondary">ƒêƒÉng xu·∫•t</a>
            </div>
        </nav>
        
        <div class="dashboard-content">
            <div class="sidebar">
                <div class="menu">
                    <a href="/dashboard" class="menu-item">
                        <span>üè†</span> Trang ch·ªß
                    </a>
                    <a href="/upload" class="menu-item active">
                        <span>üì§</span> G·ª≠i file
                    </a>
                    <a href="/history" class="menu-item">
                        <span>üìã</span> L·ªãch s·ª≠
                    </a>
                    {% if is_admin %}
                    <a href="/admin" class="menu-item">
                        <span>‚öôÔ∏è</span> Qu·∫£n tr·ªã
                    </a>
                    {% endif %}
                </div>
            </div>
            
            <div class="main-content">
                <div class="upload-header">
                    <h1>üì§ G·ª≠i file v·ªõi ch·ªØ k√Ω s·ªë</h1>
                    <p>File s·∫Ω ƒë∆∞·ª£c k√Ω b·∫±ng kh√≥a RSA c·ªßa b·∫°n ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn</p>
                </div>
                
                <div class="upload-container">
                    <form id="uploadForm" class="upload-form" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="file">Ch·ªçn file</label>
                            <div class="file-input-container">
                                <input type="file" id="file" name="file" required>
                                <div class="file-input-display">
                                    <span class="file-icon">üìÅ</span>
                                    <span class="file-text">Ch·ªçn file ƒë·ªÉ g·ª≠i</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="receiver">Ng∆∞·ªùi nh·∫≠n</label>
                            <select id="receiver" name="receiver" required>
                                <option value="">Ch·ªçn ng∆∞·ªùi nh·∫≠n</option>
                                {% for user in all_users %}
                                    {% if user != current_user %}
                                    <option value="{{ user }}">{{ user }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="user_key">Kh√≥a c√° nh√¢n c·ªßa b·∫°n</label>
                            <input type="password" id="user_key" name="user_key" required placeholder="Nh·∫≠p kh√≥a c√° nh√¢n ƒë·ªÉ k√Ω file">
                            <small>Kh√≥a n√†y s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ t·∫°o ch·ªØ k√Ω s·ªë cho file</small>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-large">
                                <span class="btn-icon">üîê</span>
                                K√Ω v√† g·ª≠i file
                            </button>
                        </div>
                    </form>
                    
                    <div class="upload-info">
                        <h3>üîí Quy tr√¨nh b·∫£o m·∫≠t</h3>
                        <div class="info-steps">
                            <div class="step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h4>Ch·ªçn file</h4>
                                    <p>File s·∫Ω ƒë∆∞·ª£c t·∫£i l√™n server an to√†n</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h4>T·∫°o ch·ªØ k√Ω</h4>
                                    <p>File ƒë∆∞·ª£c k√Ω b·∫±ng kh√≥a RSA ri√™ng c·ªßa b·∫°n</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h4>G·ª≠i th√¥ng b√°o</h4>
                                    <p>Ng∆∞·ªùi nh·∫≠n s·∫Ω ƒë∆∞·ª£c th√¥ng b√°o v·ªÅ file m·ªõi</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h4>X√°c minh</h4>
                                    <p>Ng∆∞·ªùi nh·∫≠n x√°c minh ch·ªØ k√Ω tr∆∞·ªõc khi t·∫£i</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="message" class="message"></div>
    
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // X·ª≠ l√Ω hi·ªÉn th·ªã file ƒë∆∞·ª£c ch·ªçn
        document.getElementById('file').addEventListener('change', function(e) {
            const fileDisplay = document.querySelector('.file-text');
            if (e.target.files.length > 0) {
                const fileName = e.target.files[0].name;
                fileDisplay.textContent = fileName;
                fileDisplay.parentElement.classList.add('file-selected');
            } else {
                fileDisplay.textContent = 'Ch·ªçn file ƒë·ªÉ g·ª≠i';
                fileDisplay.parentElement.classList.remove('file-selected');
            }
        });
        
        // X·ª≠ l√Ω form upload
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Disable button v√† hi·ªÉn th·ªã loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="btn-icon">‚è≥</span> ƒêang g·ª≠i...';
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    // Reset form
                    e.target.reset();
                    document.querySelector('.file-text').textContent = 'Ch·ªçn file ƒë·ªÉ g·ª≠i';
                    document.querySelector('.file-input-display').classList.remove('file-selected');
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
            } finally {
                // Enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span class="btn-icon">üîê</span> K√Ω v√† g·ª≠i file';
            }
        });
    </script>
</body>
</html>
