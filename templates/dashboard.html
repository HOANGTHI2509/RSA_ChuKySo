<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - File Transfer RSA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        .verify-info {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .verify-info h4 {
            color: #495057;
            margin-bottom: 12px;
        }

        .verify-info ol {
            margin: 0;
            padding-left: 20px;
        }

        .verify-info li {
            margin-bottom: 8px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <nav class="navbar">
            <div class="nav-brand">
                <h2>üîê File Transfer RSA</h2>
            </div>
            <div class="nav-user">
                <span>Xin ch√†o, <strong>{{ username }}</strong></span>
                {% if is_admin %}
                    <span class="admin-badge">Admin</span>
                {% endif %}
                <a href="/logout" class="btn btn-secondary">ƒêƒÉng xu·∫•t</a>
            </div>
        </nav>
        
        <div class="dashboard-content">
            <div class="sidebar">
                <div class="menu">
                    <a href="/dashboard" class="menu-item active">
                        <span>üè†</span> Trang ch·ªß
                    </a>
                    <a href="/upload" class="menu-item">
                        <span>üì§</span> G·ª≠i file
                    </a>
                    <a href="/history" class="menu-item">
                        <span>üìã</span> L·ªãch s·ª≠
                    </a>
                    {% if is_admin %}
                    <a href="/admin" class="menu-item">
                        <span>‚öôÔ∏è</span> Qu·∫£n tr·ªã
                    </a>
                    {% endif %}
                </div>
                
                <div class="online-users">
                    <h3>üë• Ng∆∞·ªùi d√πng online</h3>
                    <div id="onlineUsersList">
                        {% for user in online_users %}
                        <div class="user-item online">
                            <span class="status-dot"></span>
                            {{ user }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="main-content">
                <div class="welcome-section">
                    <h1>Ch√†o m·ª´ng ƒë·∫øn v·ªõi File Transfer RSA</h1>
                    <p>H·ªá th·ªëng truy·ªÅn file an to√†n v·ªõi ch·ªØ k√Ω s·ªë RSA</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üì§</div>
                        <div class="stat-info">
                            <h3>G·ª≠i file</h3>
                            <p>G·ª≠i file v·ªõi ch·ªØ k√Ω s·ªë</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üì•</div>
                        <div class="stat-info">
                            <h3>Nh·∫≠n file</h3>
                            <p>X√°c minh v√† t·∫£i file</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üîê</div>
                        <div class="stat-info">
                            <h3>B·∫£o m·∫≠t</h3>
                            <p>Ch·ªØ k√Ω RSA 2048-bit</p>
                        </div>
                    </div>
                </div>
                
                {% if received_files %}
                <div class="received-files">
                    <h2>üì• File ƒë√£ nh·∫≠n</h2>
                    <div class="files-grid">
                        {% for file in received_files %}
                        <div class="file-card">
                            <div class="file-icon">üìÑ</div>
                            <div class="file-info">
                                <h4>{{ file.filename }}</h4>
                                <p>T·ª´: <strong>{{ file.sender }}</strong></p>
                                <p>Th·ªùi gian: {{ file.timestamp[:19] }}</p>
                                {% if file.verified %}
                                    <span class="status verified">‚úÖ ƒê√£ x√°c minh</span>
                                {% else %}
                                    <span class="status pending">‚è≥ Ch∆∞a x√°c minh</span>
                                {% endif %}
                            </div>
                            <div class="file-actions">
                                {% if not file.verified %}
                                <button class="btn btn-primary" onclick="verifyFile('{{ file.id }}')">
                                    X√°c minh
                                </button>
                                {% else %}
                                <a href="/api/download/{{ file.id }}" class="btn btn-success">
                                    T·∫£i xu·ªëng
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Modal x√°c minh file -->
    <div id="verifyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîê X√°c minh ch·ªØ k√Ω file</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="verify-info">
                    <h4>üìã Quy tr√¨nh x√°c minh:</h4>
                    <ol>
                        <li>B·∫°n nh·∫≠p kh√≥a c√° nh√¢n ƒë·ªÉ x√°c th·ª±c danh t√≠nh</li>
                        <li>H·ªá th·ªëng s·ª≠ d·ª•ng <strong>public key c·ªßa ng∆∞·ªùi g·ª≠i</strong> ƒë·ªÉ ki·ªÉm tra ch·ªØ k√Ω</li>
                        <li>N·∫øu ch·ªØ k√Ω h·ª£p l·ªá, file ƒë∆∞·ª£c ƒë·∫£m b·∫£o t·ª´ ng∆∞·ªùi g·ª≠i v√† kh√¥ng b·ªã thay ƒë·ªïi</li>
                    </ol>
                </div>
                <div class="form-group">
                    <label for="verifyKey">Nh·∫≠p kh√≥a c√° nh√¢n c·ªßa b·∫°n:</label>
                    <input type="password" id="verifyKey" placeholder="Kh√≥a c√° nh√¢n ƒë·ªÉ x√°c th·ª±c danh t√≠nh">
                    <small>Kh√≥a n√†y ch·ªâ ƒë·ªÉ x√°c th·ª±c b·∫°n l√† ng∆∞·ªùi nh·∫≠n h·ª£p l·ªá</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="confirmVerify()">X√°c minh ch·ªØ k√Ω</button>
            </div>
        </div>
    </div>
    
    <div id="message" class="message"></div>
    
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        const socket = io();
        let currentFileId = null;
        
        socket.on('connect', function() {
            console.log('Connected to server');
        });
        
        socket.on('user_online', function(data) {
            updateOnlineUsers();
        });
        
        socket.on('user_offline', function(data) {
            updateOnlineUsers();
        });
        
        socket.on('online_users', function(data) {
            updateOnlineUsersList(data.users);
        });
        
        socket.on('new_file', function(data) {
            showMessage(`B·∫°n c√≥ file m·ªõi t·ª´ ${data.sender}: ${data.filename}`, 'info');
            setTimeout(() => {
                location.reload();
            }, 2000);
        });
        
        function updateOnlineUsersList(users) {
            const container = document.getElementById('onlineUsersList');
            container.innerHTML = '';
            
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item online';
                userDiv.innerHTML = `
                    <span class="status-dot"></span>
                    ${user}
                `;
                container.appendChild(userDiv);
            });
        }
        
        function verifyFile(fileId) {
            currentFileId = fileId;
            document.getElementById('verifyModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('verifyModal').style.display = 'none';
            document.getElementById('verifyKey').value = '';
            currentFileId = null;
        }
        
        async function confirmVerify() {
            const userKey = document.getElementById('verifyKey').value;
            
            if (!userKey) {
                showMessage('Vui l√≤ng nh·∫≠p kh√≥a c√° nh√¢n', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_id: currentFileId,
                        user_key: userKey
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    closeModal();
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('L·ªói k·∫øt n·ªëi', 'error');
            }
        }
        
        // ƒê√≥ng modal khi click outside
        window.onclick = function(event) {
            const modal = document.getElementById('verifyModal');
            if (event.target == modal) {
                closeModal();
            }
        }
        
        // ƒê√≥ng modal khi click n√∫t X
        document.querySelector('.close').onclick = function() {
            closeModal();
        }
    </script>
</body>
</html>
